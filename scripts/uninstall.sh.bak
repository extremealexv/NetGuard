#!/bin/bash

# Color definitions
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Function to print status messages
status() {
    echo -e "${CYAN}ℹ️ $1${NC}"
}

success() {
    echo -e "${GREEN}✅ $1${NC}"
}

warning() {
    echo -e "${YELLOW}⚠️ $1${NC}"
}

error() {
    echo -e "${RED}❌ $1${NC}"
    exit 1
}

# Check if script is run as root
if [ "$EUID" -ne 0 ]; then 
    error "Please run as root"
fi

# Print header
echo -e "${CYAN}🗑️ Netureon Uninstallation Script${NC}"
echo -e "${CYAN}============================${NC}"
echo

# Ask for confirmation
echo -e "${YELLOW}⚠️ WARNING: This will remove all Netureon services and their data${NC}"
echo "The following actions will be performed:"
echo "1. Stop all Netureon services"
echo "2. Remove systemd services"
echo "3. Remove service configurations"
echo "4. Clean up program data"
echo
read -p "Do you want to proceed? (y/N) " confirm
if [[ ! $confirm =~ ^[yY]$ ]]; then
    status "Uninstallation cancelled"
    exit 0
fi

# Stop services
status "Stopping services..."
services=(
    "netureon"
    "netureon-alerts"
    "netureon_web"
    "netureon_scan.timer"
    "netureon_scan"
)

for service in "${services[@]}"; do
    if systemctl is-active --quiet "$service"; then
        systemctl stop "$service"
        success "Stopped $service"
    fi
done

# Disable services
status "Disabling services..."
for service in "${services[@]}"; do
    if systemctl is-enabled --quiet "$service" 2>/dev/null; then
        systemctl disable "$service"
        success "Disabled $service"
    fi
done

# Remove service files
status "Removing service files..."
service_files=(
    "/etc/systemd/system/netureon.service"
    "/etc/systemd/system/netureon-alerts.service"
    "/etc/systemd/system/netureon_web.service"
    "/etc/systemd/system/netureon_scan.service"
    "/etc/systemd/system/netureon_scan.timer"
)

for file in "${service_files[@]}"; do
    if [ -f "$file" ]; then
        rm -f "$file"
        success "Removed $file"
    fi
done

# Reload systemd
systemctl daemon-reload
success "Reloaded systemd configuration"

# Backup database
status "Backing up database..."
source .env 2>/dev/null || true
db_name=${DB_NAME:-netureon}
db_user=${DB_USER:-postgres}

timestamp=$(date +%Y%m%d%H%M%S)
backup_file="netureon_backup_$timestamp.sql"

if command -v pg_dump &>/dev/null; then
    if PGPASSWORD=$DB_PASS pg_dump -h ${DB_HOST:-localhost} -p ${DB_PORT:-5432} -U $db_user $db_name > "$backup_file" 2>/dev/null; then
        success "Database backup created: $backup_file"
    else
        warning "Failed to backup database"
    fi
else
    warning "pg_dump not found, skipping database backup"
fi

# Remove log directory
log_dir="/var/log/netureon"
if [ -d "$log_dir" ]; then
    rm -rf "$log_dir"
    success "Removed log directory: $log_dir"
fi

success "Uninstallation complete"
echo
echo "Note: The database and its data have been preserved."
echo "A backup has been created in the current directory."
echo "To completely remove all data, manually drop the database:"
echo "psql -U postgres -c 'DROP DATABASE netureon'"
